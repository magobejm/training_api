datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // ADMIN, TRAINER, CLIENT
  description String?
  
  // Relations
  users       User[]
  
  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")

  @@map("roles")
}

model MuscleGroup {
  id          String     @id @default(uuid())
  name        String     @unique // PECTORAL, DORSAL, etc.
  imageUrl    String?    @map("image_url")
  
  // Relations
  exercises   Exercise[]
  
  // Audit
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt      @map("updated_at")

  @@map("muscle_groups")
}

model Organization {
  id   String @id @default(uuid())
  name String

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  users User[]

  @@map("organizations")
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String? @map("password_hash")
  
  // Relation (Enforced)
  roleId   String  @map("role_id")
  userRole Role    @relation(fields: [roleId], references: [id])

  organizationId String?       @map("organization_id")
  // ... rest of User model
  organization   Organization? @relation(fields: [organizationId], references: [id])
  name           String? // User's real name (e.g. John Doe)
  avatarUrl      String?       @map("avatar_url") // Custom profile picture url
  
  // Physical Profile
  birthDate        DateTime? @map("birth_date")
  gender           Gender?
  height           Float?    // cm
  weight           Float?    // kg
  maxHeartRate     Int?      @map("max_heart_rate")
  restingHeartRate Int?      @map("resting_heart_rate")
  leanMass         Float?    @map("lean_mass") // %
  phone            String?
  goal             String?

  // Trainer Association
  trainerId     String? @map("trainer_id")
  trainer       User?   @relation("TrainerToClient", fields: [trainerId], references: [id])
  clients       User[]  @relation("TrainerToClient")

  // Relations
  trainingPlans            TrainingPlan[]     @relation("CreatedPlans")
  workoutSessions          WorkoutSession[]
  bodyMetrics              BodyMetric[]
  progressPhotos           ProgressPhoto[]
  clientConsultations      Consultation[]     @relation("ClientConsultations")
  trainerConsultations     Consultation[]     @relation("TrainerConsultations")
  messages                 Message[]
  userScheduledWorkouts    ScheduledWorkout[] @relation("UserScheduledWorkouts")
  trainerScheduledWorkouts ScheduledWorkout[] @relation("TrainerScheduledWorkouts")

  activePlanId String?       @map("active_plan_id")
  activePlan   TrainingPlan? @relation("ActivePlan", fields: [activePlanId], references: [id])

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Password Reset
  resetToken        String?       @unique @map("reset_token")
  resetTokenExpires DateTime?     @map("reset_token_expires")
  trainingPlan      TrainingPlan? @relation(fields: [trainingPlanId], references: [id])
  trainingPlanId    String?

  trainerExercises  Exercise[]    @relation("TrainerExercises")

  // Coach Notes
  clientNotes       CoachNote[]   @relation("ClientNotes")
  authoredNotes     CoachNote[]   @relation("AuthorNotes")

  @@map("users")
}

model Exercise {
  id              String  @id @default(uuid())
  name            String
  description     String
  defaultVideoUrl String? @map("default_video_url")
  defaultImageUrl String? @map("default_image_url") // Cloudinary URL
  thumbnailUrl    String? @map("thumbnail_url") // Optional thumbnail
  
  // Relation (Enforced)
  muscleGroupId   String      @map("muscle_group_id")
  targetMuscleGroup MuscleGroup @relation(fields: [muscleGroupId], references: [id])

  // Ownership
  trainerId       String?     @map("trainer_id")
  trainer         User?       @relation("TrainerExercises", fields: [trainerId], references: [id])

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Relations
  dayExercises DayExercise[]

  @@map("exercises")
}

model TrainingPlan {
  id          String  @id @default(uuid())
  name        String
  description String?

  authorId String @map("author_id")
  author   User   @relation("CreatedPlans", fields: [authorId], references: [id])

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Relations
  days        TrainingDay[]
  activeUsers User[]        @relation("ActivePlan")
  users       User[]

  @@index([authorId])
  @@map("training_plans")
}

model TrainingDay {
  id          String  @id @default(uuid())
  name        String
  description String?
  order       Int

  planId String @map("plan_id")

  // Relations
  plan              TrainingPlan       @relation(fields: [planId], references: [id])
  exercises         DayExercise[]
  workoutSessions   WorkoutSession[]
  scheduledWorkouts ScheduledWorkout[]

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([planId, order])
  @@index([planId])
  @@map("training_days")
}

model DayExercise {
  id String @id @default(uuid())

  dayId String      @map("day_id")
  day   TrainingDay @relation(fields: [dayId], references: [id])

  exerciseId String   @map("exercise_id")
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  order Int

  // Overrides
  customDescription String? @map("custom_description")
  customVideoUrl    String? @map("custom_video_url")
  customImageUrl    String? @map("custom_image_url") // Cloudinary override
  coachNotes        String? @map("coach_notes")

  // Prescription
  targetSets  Int    @map("target_sets")
  targetReps  String @map("target_reps") // String to allow ranges "10-12"
  targetRir   Int?   @map("target_rir")
  restSeconds Int    @map("rest_seconds")

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Relations
  workoutSets WorkoutSet[]

  @@index([dayId])
  @@index([exerciseId])
  @@map("day_exercises")
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

model WorkoutSession {
  id            String @id @default(uuid())
  userId        String @map("user_id")
  trainingDayId String @map("training_day_id")

  status      SessionStatus @default(IN_PROGRESS)
  startedAt   DateTime      @map("started_at")
  completedAt DateTime?     @map("completed_at")

  totalVolume     Float? @map("total_volume") // Calculado
  durationSeconds Int?   @map("duration_seconds") // Calculado

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id])
  trainingDay TrainingDay  @relation(fields: [trainingDayId], references: [id])
  sets        WorkoutSet[]

  @@index([userId])
  @@index([trainingDayId])
  @@index([status])
  @@map("workout_sessions")
}

model WorkoutSet {
  id            String @id @default(uuid())
  sessionId     String @map("session_id")
  dayExerciseId String @map("day_exercise_id")

  setIndex   Int   @map("set_index") // 1-based
  weightDone Float @map("weight_done") // kg decimal
  repsDone   Int   @map("reps_done")
  rpeDone    Int?  @map("rpe_done") // 1-10, opcional

  restStartedAt   DateTime? @map("rest_started_at")
  restCompletedAt DateTime? @map("rest_completed_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  session     WorkoutSession @relation(fields: [sessionId], references: [id])
  dayExercise DayExercise    @relation(fields: [dayExerciseId], references: [id])

  @@unique([sessionId, dayExerciseId, setIndex]) // Idempotencia
  @@index([sessionId])
  @@map("workout_sets")
}

model BodyMetric {
  id     String @id @default(uuid())
  userId String @map("user_id")

  weight       Float // kg, obligatorio
  height       Float? // cm, obligatorio en primer registro
  bodyFat      Float?  @map("body_fat") // %, opcional
  
  // New Metrics
  waist        Float?  // cm
  hips         Float?  // cm
  chest        Float?  // cm
  arm          Float?  // cm (avg/singular)
  leg          Float?  // cm (avg/singular)

  measurements Json? // { chest, waist, hips, etc. } - Original field kept for other measurements?
  notes        String?

  loggedAt DateTime @default(now()) @map("logged_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([loggedAt])
  @@map("body_metrics")
}

model ProgressPhoto {
  id     String @id @default(uuid())
  userId String @map("user_id")

  imageUrl String   @map("image_url") // Cloudinary
  caption  String?
  loggedAt DateTime @default(now()) @map("logged_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([loggedAt])
  @@map("progress_photos")
}

enum ConsultationStatus {
  OPEN
  RESOLVED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

model Consultation {
  id        String @id @default(uuid())
  clientId  String @map("client_id")
  trainerId String @map("trainer_id")

  subject  String
  status   ConsultationStatus @default(OPEN)
  priority Priority           @default(MEDIUM)

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  resolvedAt DateTime? @map("resolved_at")

  // Relations
  client   User      @relation("ClientConsultations", fields: [clientId], references: [id])
  trainer  User      @relation("TrainerConsultations", fields: [trainerId], references: [id])
  messages Message[]

  @@index([clientId])
  @@index([trainerId])
  @@index([status])
  @@map("consultations")
}

model Message {
  id             String @id @default(uuid())
  consultationId String @map("consultation_id")
  senderId       String @map("sender_id")

  content String    @db.Text
  readAt  DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id])
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([consultationId])
  @@index([senderId])
  @@map("messages")
}

model ScheduledWorkout {
  id            String @id @default(uuid())
  userId        String @map("user_id")
  trainerId     String @map("trainer_id")
  trainingDayId String @map("training_day_id")

  scheduledFor DateTime @map("scheduled_for")
  reminderSent Boolean  @default(false) @map("reminder_sent")
  completed    Boolean  @default(false)
  notes        String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user        User        @relation("UserScheduledWorkouts", fields: [userId], references: [id])
  trainer     User        @relation("TrainerScheduledWorkouts", fields: [trainerId], references: [id])
  trainingDay TrainingDay @relation(fields: [trainingDayId], references: [id])

  @@index([userId])
  @@index([trainerId])
  @@index([scheduledFor])
  @@map("scheduled_workouts")
}

model CoachNote {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  authorId  String   @map("author_id")
  
  content   String   @db.Text
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  client    User     @relation("ClientNotes", fields: [clientId], references: [id])
  author    User     @relation("AuthorNotes", fields: [authorId], references: [id])

  @@index([clientId])
  @@index([authorId])
  @@map("coach_notes")
}
